# List available commands
[private]
default:
  just --justfile {{justfile()}} --list chart

# Publish the packaged chart to an OCI registry.
# Registry URL is resolved in the script from env, not from Justfile interpolation.
# Defaults to ghcr.io/<owner>/charts, which results in charts at ghcr.io/<owner>/charts/<chartname>
publish registry="":
  #!/usr/bin/env bash
  set -e

  cd {{justfile_directory()}}

  echo "üîê Logging in to Helm registry..."
  # Resolve full registry path:
  # 1. CLI arg: `just chart publish registry="ghcr.io/org/charts"`
  # 2. Env: HELM_REGISTRY (e.g. "ghcr.io/hotosm/charts")
  # 3. Default: ghcr.io/<owner>/charts
  REGISTRY="{{ registry }}"
  if [ -z "$REGISTRY" ]; then
      if [ -n "${HELM_REGISTRY:-}" ]; then
          REGISTRY="${HELM_REGISTRY}"
      else
          OWNER="${HELM_REGISTRY_OWNER:-${GITHUB_REPOSITORY_OWNER:-}}"
          if [ -z "$OWNER" ]; then
              echo "‚ùå Unable to determine chart registry owner."
              echo "   Provide one of:"
              echo "     - just chart publish registry=\"ghcr.io/<owner>/charts\""
              echo "     - HELM_REGISTRY=\"ghcr.io/<owner>/charts\""
              echo "     - HELM_REGISTRY_OWNER or GITHUB_REPOSITORY_OWNER"
              exit 1
          fi
          REGISTRY="ghcr.io/${OWNER}/charts"
      fi
  fi

  REGISTRY_HOST="$(printf '%s\n' "$REGISTRY" | cut -d/ -f1)"
  echo "REGISTRY: ${REGISTRY}"
  echo "REGISTRY_HOST: ${REGISTRY_HOST}"

  # Prefer explicit Helm registry creds, fall back to GitHub defaults in CI
  USERNAME="${HELM_REGISTRY_USERNAME:-${GITHUB_ACTOR:-}}"
  PASSWORD="${HELM_REGISTRY_PASSWORD:-${GITHUB_TOKEN:-}}"

  if [ -z "$USERNAME" ] || [ -z "$PASSWORD" ]; then
      echo "‚ùå Missing registry credentials."
      echo "   Set HELM_REGISTRY_USERNAME / HELM_REGISTRY_PASSWORD"
      echo "   or rely on GITHUB_ACTOR / GITHUB_TOKEN in GitHub Actions."
      exit 1
  fi

  echo "$PASSWORD" | helm registry login "$REGISTRY_HOST" \
    --username "$USERNAME" \
    --password-stdin

  just chart build

  CHART_FILE=$(ls -t xlsform-builder-*.tgz | head -1)
  if [ -z "$CHART_FILE" ]; then
      echo "‚ùå No chart file found. Run build first"
      exit 1
  fi

  echo "üöÄ Publishing chart to OCI registry..."
  echo "üì¶ Chart file: $CHART_FILE"

  echo "üîé Checking if chart version already exists in registry..."
  CHART_VERSION=$(helm show chart "$CHART_FILE" | grep '^version:' | awk '{ print $2 }')
  if helm show chart "oci://$REGISTRY/xlsform-builder" --version "$CHART_VERSION" >/dev/null 2>&1; then
      echo "‚ÑπÔ∏è Chart version $CHART_VERSION already exists in OCI registry."
      echo "   Skipping push."
      exit 0
  fi

  echo "üì§ Pushing to: oci://$REGISTRY"
  helm push "$CHART_FILE" "oci://$REGISTRY"

  echo "‚úÖ Chart published!"

# Build the Helm chart: lint, update deps, test, and package
build:
  #!/usr/bin/env bash
  set -e
  
  # Ensure Helm is available (works locally and in CI)
  just _install-helm

  cd {{justfile_directory()}}

  echo "üî® Building Helm chart..."
  echo ""
  
  just chart lint
  just chart dependencies
  just chart package

# Lint the Helm chart
lint:
  #!/usr/bin/env sh
  set -e

  cd {{justfile_directory()}}
  echo "üîç Linting chart..."
  helm lint ./chart
  echo "‚úì Lint passed"
  echo ""

# Update chart dependences
dependencies:
  #!/usr/bin/env sh
  set -e

  cd {{justfile_directory()}}/chart
  echo "üì• Updating dependencies..."
  helm dependency update
  cd ..
  echo "‚úì Dependencies updated"
  echo ""

# Package the Helm chart
package:
  #!/usr/bin/env bash
  set -e

  cd {{justfile_directory()}}
  echo "üì¶ Packaging chart..."
  helm package ./chart
  PACKAGE=$(ls -t xlsform-builder-*.tgz | head -1)
  echo "‚úì Chart packaged: $PACKAGE"
  echo ""
  echo "‚úÖ Build complete!"

# Render chart templates
template:
  #!/usr/bin/env bash
  set -e
  cd {{justfile_directory()}}
  helm template xlsform-builder ./chart

# Show chart information
show:
  #!/usr/bin/env bash
  set -e
  cd {{justfile_directory()}}
  helm show all ./chart

# Clean up packaged charts
clean:
  #!/usr/bin/env bash
  set -e
  
  cd {{justfile_directory()}}
  rm -f xlsform-builder-*.tgz
  rm -rf chart/charts/
  echo "‚úì Cleaned up chart artifacts"
